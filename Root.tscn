[gd_scene load_steps=2 format=1]

[sub_resource type="GDScript" id=1]

script/source = "extends Node\n\nclass SpriteFrame extends Reference:\n\tvar name = \"\"\n\tvar region = Rect2(0, 0, 0, 0)\n\tvar rotation = 0\n\nfunc _ready():\n\tload_spritesheet(\"/Users/oivoodoo/projects/games/mario/assets/sprites/spritesheet_tilesRed.xml\")\n\nfunc load_spritesheet(path):\n\tvar file = File.new()\n\tfile.open(path, File.READ)\n\tif file.is_open():\n\t\tvar content = file.get_as_text()\n\t\tvar atlas = _parse(content)\n\t\t_save(path, atlas)\n\tfile.close()\n\t\nfunc _get_parent_dir(path):\n\tvar fileName = path.substr(0, path.find_last(\"/\"))\n\treturn fileName\n\nfunc _get_file_name(path):\n\tvar filename = path.substr(path.find_last(\"/\")+1, path.length() - path.find_last(\"/\")-1)\n\tvar pos = filename.find_last(\".\")\n\tif pos != -1:\n\t\tfilename = filename.substr(0, pos)\n\treturn filename\n\nfunc _save(path, atlas):\n\tvar tex = null\n\tif ResourceLoader.has(path):\n\t\ttex = ResourceLoader.load(path)\n\telse:\n\t\ttex = ImageTexture.new()\n\ttex.load(path)\n\t\n\tif not ResourceLoader.has(path):\n\t\ttex.set_path(path)\n\telse:\n\t\ttex.take_over_path(path)\n\ttex.set_name(path)\n\tResourceSaver.save(path, tex)\n\t\n\tvar tarDir = _get_parent_dir(path)\n\t\n\tfor s in atlas.sprites:\n\t\tvar atex = AtlasTexture.new()\n\t\tvar ap = str(tarDir, \"/\", _get_file_name(path), \".\", _get_file_name(s.name), \".atex\")\n\t\tprint(ap)\n\t\tif not ResourceLoader.has(ap):\n\t\t\tatex.set_path(ap)\n\t\telse:\n\t\t\tatex.take_over_path(ap)\n\t\tatex.set_path(ap)\n\t\tatex.set_name(_get_file_name(s.name))\n\t\tatex.set_atlas(tex)\n\t\tatex.set_region(s.region)\n\t\tResourceSaver.save(ap, atex)\n\treturn tex\n\nfunc _parse(content):\n\tvar atlas = {}\n\tatlas[\"sprites\"] = []\n\tvar xmlParser = XMLParser.new()\n\n\tif OK == xmlParser.open_buffer(content.to_utf8()):\n\t\tvar err = xmlParser.read()\n\n\t\twhile(err != ERR_FILE_EOF):\n\t\t\tif xmlParser.get_node_type() == xmlParser.NODE_ELEMENT:\n\t\t\t\tif xmlParser.get_node_name() == \"TextureAtlas\":\n\t\t\t\t\tatlas[\"imagePath\"] = xmlParser.get_named_attribute_value(\"imagePath\")\n\t\t\t\t\tif xmlParser.has_attribute(\"width\"):\n\t\t\t\t\t\tatlas[\"width\"] = xmlParser.get_named_attribute_value(\"width\")\n\t\t\t\t\tif xmlParser.has_attribute(\"height\"):\n\t\t\t\t\t\tatlas[\"height\"] = xmlParser.get_named_attribute_value(\"height\")\n\t\t\t\telif xmlParser.get_node_name() == \"SubTexture\":\n\t\t\t\t\tvar sprite = SpriteFrame.new()\n\t\t\t\t\tsprite.name = xmlParser.get_named_attribute_value(\"name\")\n\t\t\t\t\tsprite.region = Rect2(xmlParser.get_named_attribute_value(\"x\"), xmlParser.get_named_attribute_value(\"y\"), xmlParser.get_named_attribute_value(\"width\"), xmlParser.get_named_attribute_value(\"height\"))\n\t\t\t\t\tsprite.rotation = 0\n\t\t\t\t\tatlas[\"sprites\"].append(sprite)\n\t\t\terr = xmlParser.read()\n\t\treturn atlas\n"

[node name="Node" type="Node"]

script/script = SubResource( 1 )


